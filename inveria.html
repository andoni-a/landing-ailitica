<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>InverIA ‚Äî Locales en venta</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg:     #192727;
  --bg2:    #1e2f2f;
  --bg3:    #223434;
  --card:   #1e3030;
  --lima:   #CDD98A;
  --lima10: rgba(205,217,138,.10);
  --lima20: rgba(205,217,138,.20);
  --lima40: rgba(205,217,138,.40);
  --ice:    #E8EDE6;
  --ice55:  rgba(232,237,230,.55);
  --ice28:  rgba(232,237,230,.28);
  --ice12:  rgba(232,237,230,.12);
  --ice06:  rgba(232,237,230,.06);
  --line:   rgba(255,255,255,.07);
  --line2:  rgba(255,255,255,.11);
  --r:      16px;
  --rsm:    10px;
  --ease:   cubic-bezier(.25,0,0,1);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden;-webkit-font-smoothing:antialiased}
body{background:var(--bg);color:var(--ice);font-family:'Manrope',sans-serif;font-size:14px}
.shell{display:grid;grid-template-columns:320px 1fr;grid-template-rows:58px 1fr;height:100vh}
/* TOPBAR */
.topbar{grid-column:1/-1;display:flex;align-items:center;gap:14px;padding:0 20px;background:rgba(25,39,39,.88);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-bottom:1px solid var(--line);z-index:20}
.logo{display:flex;align-items:center;gap:10px;padding-right:18px;border-right:1px solid var(--line);flex-shrink:0}
.logo-icon{width:28px;height:28px}
.logo-name{font-size:15px;font-weight:700;letter-spacing:-.03em}
.logo-name em{font-style:normal;color:var(--lima)}
.status{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--ice55)}
.sdot{width:6px;height:6px;border-radius:50%;background:var(--lima);flex-shrink:0;animation:pulse 2.8s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.7)}}
.tgap{flex:1}
.sel-info{font-size:12px;font-weight:500;color:var(--ice28);transition:color .2s;white-space:nowrap}
.sel-info.on{color:var(--lima)}
.divider{width:1px;height:18px;background:var(--line)}
.btn-connect{height:34px;padding:0 20px;border-radius:20px;border:none;background:var(--lima);color:#192727;font-family:'Manrope',sans-serif;font-size:13px;font-weight:700;letter-spacing:-.01em;cursor:pointer;transition:opacity .18s var(--ease),transform .18s var(--ease);white-space:nowrap}
.btn-connect:not(:disabled):hover{opacity:.85;transform:scale(1.025)}
.btn-connect:not(:disabled):active{transform:scale(.96)}
.btn-connect:disabled{background:var(--ice06);color:var(--ice28);border:1px solid var(--line2);cursor:default}
/* CHAT */
.chat{display:flex;flex-direction:column;border-right:1px solid var(--line);background:var(--bg);overflow:hidden}
.chat-header{padding:22px 20px 16px;flex-shrink:0;border-bottom:1px solid var(--line)}
.chat-title{font-size:17px;font-weight:700;letter-spacing:-.03em;margin-bottom:4px}
.chat-sub{font-size:12px;color:var(--ice55);line-height:1.55}
.msgs{flex:1;overflow-y:auto;padding:14px 14px 6px;display:flex;flex-direction:column;gap:8px;scrollbar-width:none}
.msgs::-webkit-scrollbar{display:none}
.msg{animation:msgIn .28s var(--ease) both}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.msg.user{display:flex;justify-content:flex-end}
.msg.bot{display:flex;justify-content:flex-start}
.bubble{max-width:88%;padding:10px 14px;font-size:13px;line-height:1.55}
.msg.user .bubble{background:var(--lima);color:#192727;font-weight:600;border-radius:18px 18px 4px 18px}
.msg.bot .bubble{background:var(--bg2);color:var(--ice);border:1px solid var(--line2);border-radius:18px 18px 18px 4px}
.typing{display:flex;align-items:center;gap:4px;padding:13px 16px;background:var(--bg2);border:1px solid var(--line2);border-radius:18px 18px 18px 4px}
.td{width:5px;height:5px;border-radius:50%;background:var(--ice55);animation:td 1.1s ease-in-out infinite}
.td:nth-child(2){animation-delay:.14s}.td:nth-child(3){animation-delay:.28s}
@keyframes td{0%,60%,100%{opacity:.3;transform:translateY(0)}30%{opacity:1;transform:translateY(-3px)}}
.sugs{padding:10px 14px 8px;display:flex;flex-wrap:wrap;gap:6px;flex-shrink:0}
.sug{background:transparent;border:1px solid var(--line2);color:var(--ice55);padding:6px 12px;border-radius:20px;font-family:'Manrope',sans-serif;font-size:11.5px;font-weight:500;cursor:pointer;transition:all .16s var(--ease)}
.sug:hover{background:var(--lima10);border-color:var(--lima40);color:var(--lima)}
.input-area{padding:8px 12px 14px;flex-shrink:0}
.inp-wrap{display:flex;align-items:flex-end;gap:8px;background:var(--bg2);border:1px solid var(--line2);border-radius:22px;padding:10px 10px 10px 16px;transition:border-color .2s var(--ease)}
.inp-wrap:focus-within{border-color:var(--lima40)}
textarea.inp{flex:1;background:transparent;border:none;outline:none;color:var(--ice);font-family:'Manrope',sans-serif;font-size:13px;resize:none;height:21px;max-height:88px;line-height:1.55;scrollbar-width:none}
textarea.inp::-webkit-scrollbar{display:none}
textarea.inp::placeholder{color:var(--ice28)}
.send-btn{width:36px;height:36px;background:var(--lima);border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:opacity .18s,transform .18s var(--ease)}
.send-btn:hover{opacity:.85;transform:scale(1.06)}
.send-btn:active{transform:scale(.92)}
.send-btn svg{fill:#192727}
/* RESULTS */
.results{display:flex;flex-direction:column;overflow:hidden}
.results-bar{height:54px;padding:0 22px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--line);flex-shrink:0}
.rcount{font-size:14px;font-weight:700;letter-spacing:-.025em}
.rquery{font-size:12px;color:var(--ice28);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sort-pills{display:flex;gap:4px}
.sp{background:transparent;border:1px solid var(--line);color:var(--ice55);padding:4px 10px;border-radius:14px;font-family:'Manrope',sans-serif;font-size:11px;font-weight:500;cursor:pointer;transition:all .15s}
.sp.on{background:var(--lima10);border-color:var(--lima40);color:var(--lima)}
.empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;text-align:center;padding:40px}
.empty-icon{width:56px;height:56px;background:var(--ice06);border-radius:18px;display:flex;align-items:center;justify-content:center}
.empty h3{font-size:16px;font-weight:600;letter-spacing:-.025em;color:var(--ice55)}
.empty p{font-size:13px;color:var(--ice28);max-width:240px;line-height:1.6}
.grid-wrap{flex:1;overflow-y:auto;padding:18px 16px;scrollbar-width:thin;scrollbar-color:var(--line) transparent}
.grid-wrap::-webkit-scrollbar{width:4px}
.grid-wrap::-webkit-scrollbar-thumb{background:var(--line2);border-radius:4px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:12px}
/* CARD */
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);overflow:hidden;cursor:pointer;transition:transform .22s var(--ease),box-shadow .22s var(--ease),border-color .18s;animation:cardIn .38s var(--ease) both}
@keyframes cardIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
.card:hover{transform:translateY(-2px);box-shadow:0 16px 48px rgba(0,0,0,.4)}
.card.sel{border-color:var(--lima);box-shadow:0 0 0 1px var(--lima),0 16px 48px rgba(0,0,0,.3)}
.card-img{position:relative;height:160px;overflow:hidden;background:linear-gradient(135deg,#1e3535,#263f3f)}
.card-img img{width:100%;height:100%;object-fit:cover;transition:transform .5s var(--ease)}
.card:hover .card-img img{transform:scale(1.04)}
.img-overlay{position:absolute;inset:0;background:linear-gradient(to bottom,transparent 50%,rgba(25,39,39,.9))}
.badge-row{position:absolute;top:10px;left:10px;right:10px;display:flex;align-items:flex-start;justify-content:space-between}
.bdg{font-size:10px;font-weight:600;letter-spacing:.02em;padding:3px 9px;border-radius:14px;backdrop-filter:blur(8px)}
.bdg-rent{background:rgba(205,217,138,.15);color:var(--lima);border:1px solid var(--lima20)}
.bdg-ref{background:rgba(255,160,80,.12);color:#f5a35a;border:1px solid rgba(255,160,80,.2)}
.chk{width:24px;height:24px;border-radius:50%;border:1.5px solid rgba(255,255,255,.2);background:rgba(25,39,39,.5);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;transition:all .18s var(--ease);flex-shrink:0}
.card.sel .chk{background:var(--lima);border-color:var(--lima)}
.chk svg{opacity:0;transition:opacity .15s}
.card.sel .chk svg{opacity:1}
.img-bottom{position:absolute;bottom:10px;left:12px}
.price-main{font-size:19px;font-weight:800;letter-spacing:-.03em;color:#fff;line-height:1}
.price-ratio{font-size:10px;color:rgba(255,255,255,.5)}
.card-body{padding:14px 16px 16px}
.card-name{font-size:13px;font-weight:600;letter-spacing:-.02em;color:var(--ice);line-height:1.35;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.card-loc{display:flex;align-items:center;gap:4px;font-size:11.5px;color:var(--ice55);margin-bottom:14px}
.stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:12px}
.stat{background:var(--ice06);border:1px solid var(--line);border-radius:var(--rsm);padding:8px 10px}
.stat-l{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ice28);margin-bottom:3px}
.stat-v{font-size:15px;font-weight:700;letter-spacing:-.025em;line-height:1}
.stat-v small{font-size:9px;font-weight:400;color:var(--ice28)}
.tags{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:14px;min-height:22px}
.tag{font-size:10px;font-weight:500;padding:3px 9px;border-radius:14px;background:var(--lima10);color:var(--lima);border:1px solid var(--lima20)}
.tag.n{background:var(--ice06);color:var(--ice55);border-color:var(--line)}
.contact{display:flex;align-items:center;gap:10px;padding-top:12px;border-top:1px solid var(--line)}
.avatar{width:28px;height:28px;border-radius:50%;background:var(--ice06);border:1px solid var(--line2);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--ice55);flex-shrink:0}
.cinfo{flex:1;overflow:hidden}
.cname{font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ctel{font-size:10.5px;color:var(--lima);font-weight:500}
.btn-view{display:flex;align-items:center;gap:4px;background:var(--lima10);border:1px solid var(--lima20);color:var(--lima);padding:5px 10px;border-radius:14px;font-family:'Manrope',sans-serif;font-size:11px;font-weight:600;cursor:pointer;text-decoration:none;transition:background .15s;flex-shrink:0}
.btn-view:hover{background:var(--lima20)}
/* TOAST */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--line2);color:var(--ice);padding:11px 22px;border-radius:30px;font-size:13px;font-weight:500;box-shadow:0 8px 40px rgba(0,0,0,.5);z-index:100;display:flex;align-items:center;gap:8px;white-space:nowrap;animation:toastIn .3s var(--ease)}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.toast-dot{width:6px;height:6px;border-radius:50%;background:var(--lima);flex-shrink:0}
</style>
</head>
<body>
<div class="shell">
  <header class="topbar">
    <div class="logo">
      <svg class="logo-icon" viewBox="0 0 200 200" fill="none">
        <rect width="200" height="200" fill="#192727"/>
        <rect x="28" y="55" width="22" height="100" fill="#CDD98A"/>
        <polygon points="50,55 72,55 116,155 94,155" fill="#CDD98A"/>
        <polygon points="94,155 116,155 188,38 166,38" fill="#CDD98A"/>
        <rect x="142" y="22" width="48" height="22" fill="#CDD98A"/>
        <rect x="168" y="22" width="22" height="48" fill="#CDD98A"/>
      </svg>
      <span class="logo-name">Inver<em>IA</em></span>
    </div>
    <div class="status"><div class="sdot"></div><span id="sLabel">Listo</span></div>
    <div class="tgap"></div>
    <span class="sel-info" id="selInfo">Sin selecci√≥n</span>
    <div class="divider"></div>
    <button class="btn-connect" id="btnConn" disabled onclick="conectar()">Conectar</button>
  </header>
  <aside class="chat">
    <div class="chat-header">
      <div class="chat-title">Busca tu local</div>
      <div class="chat-sub">Describe en lenguaje natural. InverIA filtrar√° el portfolio y mostrar√° los resultados.</div>
    </div>
    <div class="msgs" id="msgs">
      <div class="msg bot"><div class="bubble">Hola üëã Soy InverIA.<br><br>Tengo <strong>33 locales</strong> en cartera en el Barrio Goya, Madrid.<br><br>Dime qu√© buscas y filtro los que encajen.</div></div>
    </div>
    <div class="sugs">
      <button class="sug" onclick="useSug(this)">Menos de 100m¬≤</button>
      <button class="sug" onclick="useSug(this)">Con rentabilidad</button>
      <button class="sug" onclick="useSug(this)">Salida de humos</button>
      <button class="sug" onclick="useSug(this)">Buen estado</button>
      <button class="sug" onclick="useSug(this)">Precio &lt; 500.000‚Ç¨</button>
      <button class="sug" onclick="useSug(this)">Ver todos</button>
    </div>
    <div class="input-area">
      <div class="inp-wrap">
        <textarea class="inp" id="inp" placeholder="Ej: local de restauraci√≥n con humos‚Ä¶" rows="1"></textarea>
        <button class="send-btn" onclick="send()">
          <svg width="15" height="15" viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
        </button>
      </div>
    </div>
  </aside>
  <section class="results">
    <div class="results-bar">
      <span class="rcount" id="rCount">33 activos</span>
      <span class="rquery" id="rQuery">Barrio Goya ¬∑ Madrid</span>
      <div class="sort-pills">
        <button class="sp on" onclick="doSort('pa',this)">Precio ‚Üë</button>
        <button class="sp" onclick="doSort('pd',this)">Precio ‚Üì</button>
        <button class="sp" onclick="doSort('md',this)">m¬≤ ‚Üì</button>
        <button class="sp" onclick="doSort('ra',this)">‚Ç¨/m¬≤ ‚Üë</button>
      </div>
    </div>
    <div class="empty" id="emptyEl" style="display:none">
      <div class="empty-icon"><svg width="22" height="22" fill="none" stroke="#CDD98A" stroke-width="1.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div>
      <h3>Sin resultados</h3><p>Intenta con otros criterios.</p>
    </div>
    <div class="grid-wrap" id="gWrap"><div class="grid" id="grid"></div></div>
  </section>
</div>
<script>
const WH_SEARCH='https://tu-n8n.com/webhook/search';
const WH_CONNECT='https://tu-n8n.com/webhook/connect';
const DUMMY=true;

const DATA=[{"URL":"https://www.idealista.com/inmueble/110169710/","Anuncio":"Local en venta en Calle de Ayala","Calle":"Calle de Ayala","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":2383490,"Ratio":11514.44,"M2":207,"M2U":0,"Planta":"2 plantas","Estado":"Segunda mano/buen estado","Rent":0,"Fachada":"Fachada de 8 m. lineales","Pie":"Situado a pie de calle","Cal":"Calefacci√≥n","Aire":"Aire acondicionado","Humos":"Salida de humos","Esc":"2 escaparates","Puerta":"Puerta de seguridad","Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/52/5c/95/1097939308.jpg","Tel":"919 38 88 19","Con":"Alcal√° Oficina"},{"URL":"https://www.idealista.com/inmueble/110539138/","Anuncio":"Local o nave en venta en Calle de Hermosilla","Calle":"Calle de Hermosilla","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":156000,"Ratio":4875,"M2":32,"M2U":28,"Planta":0,"Estado":"Segunda mano/buen estado","Rent":0,"Fachada":0,"Pie":0,"Cal":"Calefacci√≥n","Aire":"Aire acondicionado","Humos":0,"Esc":0,"Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/f6/5a/6e/1408010709.jpg","Tel":"915 35 72 00","Con":"Vivienda2"},{"URL":"https://www.idealista.com/inmueble/109740602/","Anuncio":"Local o nave en venta en Calle de Jorge Juan","Calle":"Calle de Jorge Juan","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":1455000,"Ratio":10543.48,"M2":138,"M2U":126,"Planta":0,"Estado":"Segunda mano/buen estado","Rent":0,"Fachada":"Fachada de 10 m. lineales","Pie":0,"Cal":"Calefacci√≥n","Aire":"Aire acondicionado","Humos":0,"Esc":0,"Puerta":"Puerta de seguridad","Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/eb/44/6b/1384149215.jpg","Tel":"915 35 72 00","Con":"Vivienda2"},{"URL":"https://www.idealista.com/inmueble/102582575/","Anuncio":"Local en rentabilidad en venta en Goya","Calle":"Barrio Goya","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":1080000,"Ratio":9000,"M2":120,"M2U":116,"Planta":"1 planta","Estado":"Segunda mano/buen estado","Rent":"Rentabilidad bruta anual 6,5%","Fachada":"Fachada de 3 m. lineales","Pie":"Situado a pie de calle","Cal":0,"Aire":"Aire acondicionado","Humos":"Salida de humos","Esc":"1 escaparates","Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/7b/1c/d8/1160319525.jpg","Tel":"919 38 32 48","Con":"Tailor & Key"},{"URL":"https://www.idealista.com/inmueble/109899428/","Anuncio":"Local en venta en Calle de Antonia Merc√©","Calle":"Calle de Antonia Merc√©","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":390000,"Ratio":4193.55,"M2":93,"M2U":0,"Planta":"1 planta","Estado":"Segunda mano/para reformar","Rent":0,"Fachada":"Fachada de 3 m. lineales","Pie":"Situado a pie de calle","Cal":0,"Aire":0,"Humos":"Salida de humos","Esc":0,"Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/05/66/58/1394927017.jpg","Tel":"919 38 26 78","Con":"DAURUM ESTATE"},{"URL":"https://www.idealista.com/inmueble/87671845/","Anuncio":"Local en venta en Calle de Don Ram√≥n de la Cruz","Calle":"Calle de Don Ram√≥n de la Cruz","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":635000,"Ratio":2212.54,"M2":287,"M2U":247,"Planta":"2 plantas","Estado":"Segunda mano/buen estado","Rent":0,"Fachada":"Fachada de 8 m. lineales","Pie":"Situado a pie de calle","Cal":0,"Aire":"Aire acondicionado","Humos":0,"Esc":"1 escaparates","Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/11/97/3f/1400030231.jpg","Tel":"914 44 92 70","Con":"Avant Real Estate"},{"URL":"https://www.idealista.com/inmueble/110659838/","Anuncio":"Restaurante, negocio de restauraci√≥n en venta","Calle":"Barrio Goya","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":10500000,"Ratio":8190.33,"M2":1282,"M2U":0,"Planta":0,"Estado":"Segunda mano/para reformar","Rent":0,"Fachada":0,"Pie":"Situado a pie de calle","Cal":0,"Aire":0,"Humos":"Salida de humos","Esc":0,"Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/df/ee/d1/1411580270.jpg","Tel":"936 17 01 35","Con":"JS Consultores"},{"URL":"https://www.idealista.com/inmueble/108295248/","Anuncio":"Local en venta en Calle de Goya","Calle":"Calle de Goya","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":599000,"Ratio":6885.06,"M2":87,"M2U":0,"Planta":0,"Estado":"Segunda mano/buen estado","Rent":0,"Fachada":0,"Pie":0,"Cal":0,"Aire":"Aire acondicionado","Humos":0,"Esc":0,"Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/d8/b2/b5/1339841402.jpg","Tel":"919 38 55 01","Con":"GRUPO INMOBILIA"},{"URL":"https://www.idealista.com/inmueble/107809969/","Anuncio":"Local en venta en Calle de Goya","Calle":"Calle de Goya","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":1330000,"Ratio":8580.65,"M2":155,"M2U":128,"Planta":0,"Estado":"Segunda mano/buen estado","Rent":0,"Fachada":0,"Pie":"Situado a pie de calle","Cal":"Calefacci√≥n","Aire":"Aire acondicionado","Humos":"Salida de humos","Esc":0,"Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/c3/d8/48/1337288699.jpg","Tel":"917 58 73 50","Con":"HH Chamberi"},{"URL":"https://www.idealista.com/inmueble/109789440/","Anuncio":"Local en rentabilidad en venta Calle de Goya, 116","Calle":"Calle de Goya, 116","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":420000,"Ratio":6885.25,"M2":61,"M2U":0,"Planta":"1 planta","Estado":"Segunda mano/buen estado","Rent":"Rentabilidad bruta anual 4,5%","Fachada":"Fachada de 5 m. lineales","Pie":"Situado a pie de calle","Cal":"Calefacci√≥n","Aire":0,"Humos":0,"Esc":"1 escaparates","Puerta":"Puerta de seguridad","Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/6f/11/ed/1391128739.jpg","Tel":"919 38 57 95","Con":"QUALITY KEYS"},{"URL":"https://www.idealista.com/inmueble/105134635/","Anuncio":"Local en venta en Calle Alcal√°, 191","Calle":"Calle Alcal√°, 191","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":1100000,"Ratio":8208.96,"M2":134,"M2U":86,"Planta":0,"Estado":"Segunda mano/buen estado","Rent":0,"Fachada":0,"Pie":0,"Cal":0,"Aire":"Aire acondicionado","Humos":0,"Esc":0,"Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/99/34/fe/1328987643.jpg","Tel":"919 38 80 62","Con":"Cristian Salgueira"},{"URL":"https://www.idealista.com/inmueble/92659089/","Anuncio":"Local en venta en Calle Naciones","Calle":"Calle Naciones","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":450000,"Ratio":2647.06,"M2":170,"M2U":160,"Planta":0,"Estado":"Segunda mano/para reformar","Rent":0,"Fachada":0,"Pie":"Situado a pie de calle","Cal":0,"Aire":0,"Humos":0,"Esc":0,"Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/da/06/39/856879591.jpg","Tel":"919 38 59 67","Con":"asenfi 2000"},{"URL":"https://www.idealista.com/inmueble/101858627/","Anuncio":"Local en venta en Goya","Calle":"Barrio Goya","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":370000,"Ratio":4625,"M2":80,"M2U":0,"Planta":0,"Estado":"Segunda mano/buen estado","Rent":0,"Fachada":0,"Pie":"Situado a pie de calle","Cal":0,"Aire":0,"Humos":0,"Esc":0,"Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/26/0f/ce/1136226795.jpg","Tel":"919 38 23 30","Con":"N√©stor Rodr√≠guez"},{"URL":"https://www.idealista.com/inmueble/108410937/","Anuncio":"Local en venta en Calle de Hermosilla, 70","Calle":"Calle de Hermosilla, 70","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":550000,"Ratio":9166.67,"M2":60,"M2U":55,"Planta":0,"Estado":"Segunda mano/buen estado","Rent":0,"Fachada":0,"Pie":0,"Cal":"Calefacci√≥n","Aire":"Aire acondicionado","Humos":0,"Esc":0,"Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/5d/a9/7c/1344127639.jpg","Tel":"919 38 78 76","Con":"MONAGO Consultores"},{"URL":"https://www.idealista.com/inmueble/97812562/","Anuncio":"Local en venta en Calle Doctor Esquerdo","Calle":"Calle Doctor Esquerdo","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":720000,"Ratio":2880,"M2":250,"M2U":0,"Planta":"2 plantas","Estado":"Segunda mano/buen estado","Rent":0,"Fachada":"Fachada de 7 m. lineales","Pie":"Situado a pie de calle","Cal":0,"Aire":0,"Humos":0,"Esc":"1 escaparates","Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/bf/60/c9/994386142.jpg","Tel":"914 44 92 70","Con":"Avant Real Estate"},{"URL":"https://www.idealista.com/inmueble/110473910/","Anuncio":"Local en venta en Calle de Don Ram√≥n de la Cruz","Calle":"Calle de Don Ram√≥n de la Cruz","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":635000,"Ratio":2220.28,"M2":286,"M2U":0,"Planta":"2 plantas","Estado":"Segunda mano/buen estado","Rent":0,"Fachada":"Fachada de 6 m. lineales","Pie":"Situado a pie de calle","Cal":0,"Aire":0,"Humos":0,"Esc":"1 escaparates","Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-P/0/id.pro.es.image.master/4e/4a/c0/1406023879.jpg","Tel":"919 38 70 74","Con":"1 EMBASSY PROPERTIES"},{"URL":"https://www.idealista.com/inmueble/106642757/","Anuncio":"Local en rentabilidad en venta en Calle de Goya","Calle":"Calle de Goya","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":1295000,"Ratio":8196.2,"M2":158,"M2U":128,"Planta":"1 planta","Estado":"Segunda mano/buen estado","Rent":"Rentabilidad bruta anual 5,4%","Fachada":"Fachada de 8 m. lineales","Pie":"Situado a pie de calle","Cal":"Calefacci√≥n","Aire":"Aire acondicionado","Humos":"Salida de humos","Esc":"3 escaparates","Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-P/90/id.pro.es.image.master/aa/c2/b3/1399240614.jpg","Tel":"919 38 38 72","Con":"Euro-Kapital"},{"URL":"https://www.idealista.com/inmueble/108341872/","Anuncio":"Local en venta en Calle de Hermosilla, 102","Calle":"Calle de Hermosilla, 102","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":2200000,"Ratio":6666.67,"M2":330,"M2U":0,"Planta":"2 plantas","Estado":"Segunda mano/buen estado","Rent":0,"Fachada":0,"Pie":"Situado a pie de calle","Cal":0,"Aire":"Aire acondicionado","Humos":0,"Esc":"2 escaparates","Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/23/45/39/1341259695.jpg","Tel":"919 38 68 58","Con":"dpto. comercial"},{"URL":"https://www.idealista.com/inmueble/109609235/","Anuncio":"Local en rentabilidad en venta en Calle Naciones","Calle":"Calle Naciones","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":415000,"Ratio":4150,"M2":100,"M2U":0,"Planta":"2 plantas","Estado":"Segunda mano/buen estado","Rent":"Rentabilidad bruta anual 6%","Fachada":"Fachada de 3 m. lineales","Pie":"Situado a pie de calle","Cal":"Calefacci√≥n","Aire":0,"Humos":0,"Esc":"1 escaparates","Puerta":"Puerta de seguridad","Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/80/cd/a7/1380017009.jpg","Tel":"919 38 01 86","Con":"dpto comercial Goya"},{"URL":"https://www.idealista.com/inmueble/107214021/","Anuncio":"Local en rentabilidad en Calle de la Fuente del Berro","Calle":"Calle de la Fuente del Berro","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":620000,"Ratio":4366.2,"M2":142,"M2U":0,"Planta":"2 plantas","Estado":"Segunda mano/buen estado","Rent":0,"Fachada":0,"Pie":"Situado a pie de calle","Cal":"Calefacci√≥n","Aire":"Aire acondicionado","Humos":0,"Esc":"1 escaparates","Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/6c/4f/3a/1306370175.jpg","Tel":"919 38 65 94","Con":"Asesora Inmobiliaria"},{"URL":"https://www.idealista.com/inmueble/110096931/","Anuncio":"Local en venta en Calle del Doctor Esquerdo","Calle":"Calle del Doctor Esquerdo","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":160000,"Ratio":1600,"M2":100,"M2U":0,"Planta":"2 plantas","Estado":"Segunda mano/para reformar","Rent":0,"Fachada":"Fachada de 3 m. lineales","Pie":"Situado a pie de calle","Cal":0,"Aire":0,"Humos":0,"Esc":"1 escaparates","Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/a9/32/d0/1395096259.jpg","Tel":"919 38 03 32","Con":"Solvia Store"},{"URL":"https://www.idealista.com/inmueble/101197575/","Anuncio":"Local en venta en Goya (gran superficie)","Calle":"Barrio Goya","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":1200000,"Ratio":1706.97,"M2":703,"M2U":435,"Planta":0,"Estado":"Segunda mano/para reformar","Rent":0,"Fachada":0,"Pie":0,"Cal":"Calefacci√≥n","Aire":0,"Humos":"Salida de humos","Esc":0,"Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/b0/6a/4a/1114103083.jpg","Tel":"919 38 95 12","Con":"REMAX COLLECTION"},{"URL":"https://www.idealista.com/inmueble/105998726/","Anuncio":"Local en rentabilidad en venta en Calle de Jorge Juan","Calle":"Calle de Jorge Juan","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":1100000,"Ratio":4721.03,"M2":233,"M2U":200,"Planta":"2 plantas","Estado":"Segunda mano/buen estado","Rent":"Rentabilidad bruta anual 5%","Fachada":"Fachada de 5 m. lineales","Pie":"Situado a pie de calle","Cal":0,"Aire":"Aire acondicionado","Humos":"Salida de humos","Esc":"2 escaparates","Puerta":"Puerta de seguridad","Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/07/c4/20/1269434434.jpg","Tel":"919 38 50 25","Con":"A&C SPACIOS"},{"URL":"https://www.idealista.com/inmueble/102691300/","Anuncio":"Local en rentabilidad en venta en Calle de Alcal√°","Calle":"Calle de Alcal√°","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":630000,"Ratio":6923.08,"M2":91,"M2U":0,"Planta":"2 plantas","Estado":"Segunda mano/buen estado","Rent":"Rentabilidad bruta anual 6%","Fachada":"Fachada de 5 m. lineales","Pie":"Situado a pie de calle","Cal":0,"Aire":"Aire acondicionado","Humos":0,"Esc":0,"Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/6a/22/7d/1163976949.jpg","Tel":"666 50 25 30","Con":"Manuel DELUXELOCAL"},{"URL":"https://www.idealista.com/inmueble/97700990/","Anuncio":"Local en venta en Goya (gran fachada)","Calle":"Barrio Goya","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":4500000,"Ratio":5300.35,"M2":849,"M2U":0,"Planta":"2 plantas","Estado":"Segunda mano/buen estado","Rent":0,"Fachada":"Fachada de 20 m. lineales","Pie":"Situado a pie de calle","Cal":0,"Aire":0,"Humos":0,"Esc":0,"Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/09/9c/20/987562115.jpg","Tel":"919 38 80 84","Con":"Savills Madrid"},{"URL":"https://www.idealista.com/inmueble/106017319/","Anuncio":"Local en rentabilidad en venta en Goya","Calle":"Calle Goya","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":550000,"Ratio":9166.67,"M2":60,"M2U":0,"Planta":0,"Estado":"Segunda mano/buen estado","Rent":"Rentabilidad bruta anual 4,65%","Fachada":0,"Pie":0,"Cal":"Calefacci√≥n","Aire":"Aire acondicionado","Humos":0,"Esc":0,"Puerta":"Puerta de seguridad","Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/16/64/44/1270013549.jpg","Tel":"919 38 22 30","Con":"Fernando Alonso"},{"URL":"https://www.idealista.com/inmueble/107624148/","Anuncio":"Local en Goya, Madrid","Calle":"Calle Goya","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":1050000,"Ratio":12804.88,"M2":82,"M2U":80,"Planta":0,"Estado":"Segunda mano/buen estado","Rent":0,"Fachada":0,"Pie":0,"Cal":0,"Aire":0,"Humos":0,"Esc":0,"Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/51/29/75/1317948978.jpg","Tel":"919 49 22 11","Con":"Luis Gallardo"},{"URL":"https://www.idealista.com/inmueble/106604977/","Anuncio":"Local o nave en Calle del Doctor Esquerdo","Calle":"Calle del Doctor Esquerdo","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":160000,"Ratio":2909.09,"M2":55,"M2U":0,"Planta":0,"Estado":"Segunda mano/buen estado","Rent":0,"Fachada":0,"Pie":0,"Cal":0,"Aire":0,"Humos":0,"Esc":0,"Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/28/03/81/1313471262.jpg","Tel":"965 02 32 90","Con":"Solvia HR"},{"URL":"https://www.idealista.com/inmueble/106658452/","Anuncio":"Local o nave en Calle del Doctor Esquerdo","Calle":"Calle del Doctor Esquerdo","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":160000,"Ratio":2909.09,"M2":55,"M2U":0,"Planta":0,"Estado":"Segunda mano/buen estado","Rent":0,"Fachada":0,"Pie":0,"Cal":0,"Aire":0,"Humos":0,"Esc":0,"Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/66/94/f3/1313399677.jpg","Tel":"919 38 40 91","Con":"Solvia SE"},{"URL":"https://www.idealista.com/inmueble/89264431/","Anuncio":"Local en Goya, Madrid","Calle":"Barrio Goya","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":392200,"Ratio":5372.6,"M2":73,"M2U":0,"Planta":0,"Estado":"Segunda mano/buen estado","Rent":0,"Fachada":"Fachada de 4 m. lineales","Pie":"Situado a pie de calle","Cal":0,"Aire":0,"Humos":0,"Esc":0,"Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/87/9f/e8/767478451.jpg","Tel":"919 38 16 65","Con":"Javier Gallardo"},{"URL":"https://www.idealista.com/inmueble/107654291/","Anuncio":"Local en rentabilidad en Goya, Madrid","Calle":"Barrio Goya","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":501600,"Ratio":12234.15,"M2":41,"M2U":0,"Planta":"1 planta","Estado":"Segunda mano/buen estado","Rent":"Rentabilidad bruta anual 5,4%","Fachada":"Fachada de 5 m. lineales","Pie":"Situado a pie de calle","Cal":0,"Aire":"Aire acondicionado","Humos":0,"Esc":"1 escaparates","Puerta":0,"Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/45/14/07/1319439298.jpg","Tel":"666 50 25 30","Con":"Manuel DELUXELOCAL"},{"URL":"https://www.idealista.com/inmueble/107243656/","Anuncio":"Local en rentabilidad en Goya, Madrid","Calle":"Barrio Goya","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":194200,"Ratio":8827.27,"M2":22,"M2U":0,"Planta":0,"Estado":"Segunda mano/buen estado","Rent":"Rentabilidad bruta anual 9%","Fachada":0,"Pie":0,"Cal":"Calefacci√≥n","Aire":"Aire acondicionado","Humos":0,"Esc":0,"Puerta":"Puerta de seguridad","Img":"https://img4.idealista.com/blur/WEB_DETAIL_TOP-L-L/0/id.pro.es.image.master/ed/10/30/1307203618.jpg","Tel":"919 38 23 51","Con":"Activos Premium"},{"URL":"https://www.idealista.com/inmueble/109285411/","Anuncio":"Local en rentabilidad en Goya, Madrid","Calle":"Barrio Goya","Barrio":"Barrio Goya","Ciudad":"Madrid","Precio":2000000,"Ratio":9708.74,"M2":206,"M2U":0,"Planta":"2 plantas","Estado":"Segunda mano/buen estado","Rent":0,"Fachada":"Fachada de 15 m. lineales","Pie":"Situado a pie de calle","Cal":"Calefacci√≥n","Aire":"Aire acondicionado","Humos":0,"Esc":"5 escaparates","Puerta":0,"Img":0,"Tel":"919 38 21 73","Con":"Ignacio Dhoce"}];

let shown=[...DATA],sel=new Set(),busy=false,sk='pa';

window.addEventListener('DOMContentLoaded',()=>{
  renderCards(shown);
  const t=document.getElementById('inp');
  t.addEventListener('input',function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,88)+'px'});
  t.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}});
});

function tags(l){
  const t=[];
  if(l.Humos)t.push({lb:'Salida de humos',c:'lima'});
  if(l.Rent&&l.Rent!==0){const m=String(l.Rent).match(/([\d,]+)%/);t.push({lb:m?'Rent. '+m[1]+'%':'En rentabilidad',c:'lima'})}
  if(l.Pie)t.push({lb:'Pie de calle',c:'n'});
  if(l.Cal)t.push({lb:'Calefacci√≥n',c:'n'});
  if(l.Aire)t.push({lb:'Aire acond.',c:'n'});
  if(l.Esc&&l.Esc!==0)t.push({lb:String(l.Esc).replace(' escaparates','')+'  escap.',c:'n'});
  if(l.Fachada&&l.Fachada!==0){const m=String(l.Fachada).match(/(\d+) m/);if(m)t.push({lb:'Fachada '+m[1]+'m',c:'n'})}
  if(l.Planta&&l.Planta!==0)t.push({lb:String(l.Planta),c:'n'});
  return t.slice(0,5);
}

function renderCards(data){
  const g=document.getElementById('grid'),e=document.getElementById('emptyEl'),w=document.getElementById('gWrap');
  document.getElementById('rCount').textContent=data.length+' activo'+(data.length!==1?'s':'');
  if(!data.length){g.innerHTML='';e.style.display='flex';w.style.visibility='hidden';return}
  e.style.display='none';w.style.visibility='visible';
  g.innerHTML=data.map((l,i)=>{
    const tg=tags(l),img=l.Img&&l.Img!==0?l.Img:null;
    const ref=String(l.Estado).includes('reformar'),hasR=l.Rent&&l.Rent!==0;
    const init=l.Con.trim().split(/\s+/).map(w=>w[0]?.toUpperCase()).slice(0,2).join('');
    const pr=l.Precio>=1000000?(l.Precio/1000000).toFixed(l.Precio%1000000===0?0:2)+'M‚Ç¨':l.Precio.toLocaleString('es-ES')+'‚Ç¨';
    const ra=Math.round(l.Ratio).toLocaleString('es-ES')+'‚Ç¨';
    const s=sel.has(l.URL);
    return `<div class="card${s?' sel':''}" id="c${i}" onclick="tog('${l.URL}',${i})" style="animation-delay:${Math.min(i*.03,.25)}s">
  <div class="card-img">
    ${img?`<img src="${img}" alt="" loading="lazy" onerror="this.style.display='none'">`:'<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:40px;opacity:.2">üè¢</div>'}
    <div class="img-overlay"></div>
    <div class="badge-row">
      <div style="display:flex;gap:5px;flex-wrap:wrap">
        ${hasR?'<span class="bdg bdg-rent">Rentabilidad</span>':''}
        ${ref?'<span class="bdg bdg-ref">A Reformar</span>':''}
      </div>
      <div class="chk"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#192727" stroke-width="3" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg></div>
    </div>
    <div class="img-bottom">
      <div class="price-main">${pr}</div>
      <div class="price-ratio">${ra} /m¬≤</div>
    </div>
  </div>
  <div class="card-body">
    <div class="card-name" title="${l.Anuncio}">${l.Anuncio}</div>
    <div class="card-loc"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>${l.Barrio} ¬∑ ${l.Ciudad}</div>
    <div class="stats">
      <div class="stat"><div class="stat-l">m¬≤ Const.</div><div class="stat-v">${l.M2}<small> m¬≤</small></div></div>
      <div class="stat"><div class="stat-l">m¬≤ √ötil</div><div class="stat-v">${l.M2U>0?l.M2U+'<small> m¬≤</small>':'<small style="font-size:11px">N/D</small>'}</div></div>
      <div class="stat"><div class="stat-l">‚Ç¨/m¬≤</div><div class="stat-v" style="font-size:12px">${Math.round(l.Ratio).toLocaleString('es-ES')}</div></div>
    </div>
    <div class="tags">${tg.length?tg.map(t=>`<span class="tag${t.c==='n'?' n':''}">${t.lb}</span>`).join(''):'<span style="font-size:11px;color:var(--ice28)">‚Äî</span>'}</div>
    <div class="contact">
      <div class="avatar">${init}</div>
      <div class="cinfo"><div class="cname">${l.Con}</div><div class="ctel">${l.Tel.trim()}</div></div>
      <a class="btn-view" href="${l.URL}" target="_blank" onclick="event.stopPropagation()">Ver <svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="7" y1="17" x2="17" y2="7"/><polyline points="7 7 17 7 17 17"/></svg></a>
    </div>
  </div>
</div>`;
  }).join('');
}

function doSort(k,b){
  document.querySelectorAll('.sp').forEach(p=>p.classList.remove('on'));b.classList.add('on');sk=k;
  applySort();renderCards(shown);
}
function applySort(){
  if(sk==='pa')shown.sort((a,b)=>a.Precio-b.Precio);
  if(sk==='pd')shown.sort((a,b)=>b.Precio-a.Precio);
  if(sk==='md')shown.sort((a,b)=>b.M2-a.M2);
  if(sk==='ra')shown.sort((a,b)=>a.Ratio-b.Ratio);
}

function useSug(el){
  const v=el.textContent;
  if(v==='Ver todos'){shown=[...DATA];applySort();document.getElementById('rQuery').textContent='Barrio Goya ¬∑ Madrid ‚Äî todos los activos';renderCards(shown);addMsg('Mostrando los 33 activos del portfolio.','bot');return}
  document.getElementById('inp').value=v;send();
}

async function send(){
  const inp=document.getElementById('inp'),q=inp.value.trim();
  if(!q||busy)return;
  busy=true;inp.value='';inp.style.height='auto';
  setS('Analizando‚Ä¶');addMsg(q,'user');showTyp();
  try{
    let res;
    if(DUMMY){await dl(1200);res=dsearch(q);}
    else{
      const r=await fetch(WH_SEARCH,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:q,ts:new Date().toISOString()})});
      res=(await r.json()).locales||[];
    }
    rmTyp();setS('Listo');
    document.getElementById('rQuery').textContent='"'+q+'"';
    shown=res;applySort();renderCards(shown);
    addMsg(res.length?`Encontr√© <strong>${res.length} activo${res.length!==1?'s':''}</strong> para "<em>${q}</em>".<br>Selecciona y pulsa <strong>Conectar</strong>.`:'No encontr√© activos con esos criterios.','bot');
  }catch(e){rmTyp();setS('Error');addMsg('Error al conectar. Int√©ntalo de nuevo.','bot');}
  busy=false;
}

function dsearch(q){
  const qL=q.toLowerCase();
  return DATA.filter(l=>{
    const txt=[l.Anuncio,l.Calle,l.Estado,l.Humos,l.Rent,l.Pie,l.Cal,l.Aire,l.Fachada].join(' ').toLowerCase();
    const mM=qL.match(/(\d+)\s*m/);
    if(mM){
      const m=parseInt(mM[1]);
      if((qL.includes('<')||qL.includes('menos'))&&l.M2>m)return false;
      if((qL.includes('>')||qL.includes('m√°s')||qL.includes('mas'))&&l.M2<m)return false;
    }
    if(qL.includes('500.000')||qL.includes('< 500'))if(l.Precio>=500000)return false;
    if(qL.includes('1.000.000')||qL.includes('< 1'))if(l.Precio>=1000000)return false;
    if(qL.match(/rentabilidad|rendimiento|renta/))if(!l.Rent||l.Rent===0)return false;
    if(qL.match(/humo|restaurac|hostel/))if(!l.Humos||l.Humos===0)return false;
    if(qL.includes('buen estado'))if(!String(l.Estado).includes('buen estado'))return false;
    if(qL.includes('reformar'))if(!String(l.Estado).includes('reformar'))return false;
    const ws=qL.split(/\s+/).filter(w=>w.length>2);
    return !ws.length||ws.some(w=>txt.includes(w));
  });
}

function tog(url,i){
  const el=document.getElementById('c'+i);
  sel.has(url)?(sel.delete(url),el?.classList.remove('sel')):(sel.add(url),el?.classList.add('sel'));
  updSel();
}
function updSel(){
  const n=sel.size,info=document.getElementById('selInfo'),btn=document.getElementById('btnConn');
  info.textContent=n?n+' seleccionado'+(n!==1?'s':''):'Sin selecci√≥n';
  info.className='sel-info'+(n?' on':'');
  btn.disabled=!n;btn.textContent=n?'Conectar ¬∑ '+n:'Conectar';
}

async function conectar(){
  if(!sel.size)return;
  const btn=document.getElementById('btnConn');
  btn.textContent='Enviando‚Ä¶';btn.disabled=true;
  const data=DATA.filter(l=>sel.has(l.URL));
  try{
    if(DUMMY)await dl(1200);
    else await fetch(WH_CONNECT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({locales:data,ts:new Date().toISOString()})});
    toast('Solicitud enviada ‚Äî '+data.length+' activo'+(data.length!==1?'s':''));
    addMsg('Solicitud enviada para <strong>'+data.length+' activo'+(data.length!==1?'s':'')+'</strong>. El equipo te contactar√° en menos de 24 h.','bot');
    sel.forEach(u=>{const i=shown.findIndex(l=>l.URL===u);if(i>=0)document.getElementById('c'+i)?.classList.remove('sel')});
    sel.clear();updSel();
  }catch{toast('Error al enviar.');updSel();}
}

function addMsg(html,type){
  const el=document.createElement('div');el.className='msg '+type;el.innerHTML='<div class="bubble">'+html+'</div>';
  const m=document.getElementById('msgs');m.appendChild(el);m.scrollTop=m.scrollHeight;
}
function showTyp(){
  const el=document.createElement('div');el.className='msg bot';el.id='typ';
  el.innerHTML='<div class="typing"><div class="td"></div><div class="td"></div><div class="td"></div></div>';
  const m=document.getElementById('msgs');m.appendChild(el);m.scrollTop=m.scrollHeight;
}
function rmTyp(){document.getElementById('typ')?.remove()}
function setS(t){document.getElementById('sLabel').textContent=t}
function toast(msg){
  document.querySelector('.toast')?.remove();
  const t=document.createElement('div');t.className='toast';t.innerHTML='<div class="toast-dot"></div>'+msg;
  document.body.appendChild(t);setTimeout(()=>t.remove(),3500);
}
function dl(ms){return new Promise(r=>setTimeout(r,ms))}
</script>
</body>
</html>
